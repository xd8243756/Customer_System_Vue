<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>新增公告</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body{font-family:Microsoft JhengHei, sans-serif;background:#F7F9FC;margin:0;padding:20px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:flex-start;justify-content:center;z-index:1000}
    .modal{background:#fff;padding:16px;border-radius:10px;width:680px;margin-top:40px}
    input,select,textarea{width:100%;padding:8px;margin-bottom:8px;border:1px solid #E0E0E0;border-radius:6px}
    .button{padding:8px 12px;border-radius:8px;border:1px solid #2F80ED;background:#2F80ED;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <h3>新增公告 <button id="closeBtn" class="btn btn-sm" style="float:right">✕</button></h3>
      <form id="form">
        <div class="mb-2">
          <label class="form-label">公告編號</label>
          <input id="announcementNo" />
        </div>
        <div class="mb-2">
          <label class="form-label">公告標題</label>
          <input id="announcementTitle" />
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">公告類別</label>
            <select id="announcementType"></select>
          </div>
          <div class="col-6">
            <label class="form-label">公告部門</label>
            <select id="announcementCategory"></select>
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">公告內容</label>
          <textarea id="announcementContent" rows="6"></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">上傳人</label>
          <select id="publishedBy"></select>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="istop" />
          <label class="form-check-label" for="istop">是否置頂</label>
        </div>
        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-primary" type="submit">新建公告</button>
          <button id="cancelBtn" type="button" class="btn btn-secondary">取消</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = 'http://localhost:5212/api';
    function fill(id, arr, vKey, tKey){ const s=document.getElementById(id); s.innerHTML=''; arr.forEach(x=>{ const o=document.createElement('option'); o.value = x[vKey] ?? x[tKey]; o.textContent = x[tKey]; s.appendChild(o); }); }

    async function init(){
      try{
        const [catsRes, typesRes, staffRes] = await Promise.all([
          fetch(`${apiBase}/Announcement_/GetAnnouncementCategory`).catch(()=>null),
          fetch(`${apiBase}/Announcement_/GetAnnouncementType`).catch(()=>null),
          fetch(`${apiBase}/CaseRecord/Staff`).catch(()=>null)
        ]);
        const cats = catsRes && catsRes.ok ? await catsRes.json() : [];
        const types = typesRes && typesRes.ok ? await typesRes.json() : [];
        const staff = staffRes && staffRes.ok ? await staffRes.json() : [];
        fill('announcementCategory', cats, 'topicCategoryId','topicCategoryName');
        fill('announcementType', types, 'topicTypeId','topicTypeName');
        fill('publishedBy', staff, 'employeeId','employeeName');
      }catch(e){ console.error('init failed',e); }
    }

    document.getElementById('closeBtn').addEventListener('click', ()=> window.history.back());
    document.getElementById('cancelBtn').addEventListener('click', ()=> window.history.back());

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        announcementNo: document.getElementById('announcementNo').value,
        announcementTitle: document.getElementById('announcementTitle').value,
        announcementType: document.getElementById('announcementType').value,
        announcementCategory: document.getElementById('announcementCategory').value,
        announcementContent: document.getElementById('announcementContent').value,
        publishedBy: document.getElementById('publishedBy').value,
        istop: !!document.getElementById('istop').checked
      };
      try{
        const r = await fetch(`${apiBase}/Announcement_`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok){ const txt = await r.text(); throw new Error(txt||'create failed'); }
        alert('公告建立成功'); window.location.href = 'Announcement.html';
      }catch(err){ console.error(err); alert('建立失敗：'+(err.message||err)); }
    });

    init();
  </script>
</body>
</html>
